## LichSOMA's DX3rd Target Assistant

**DX3rd Target Assistant**는 Foundry VTT v13, `double-cross-3rd` 시스템, `sequencer` 모듈을 사용하는 환경에서  
콤보 / 이펙트 / 스펠 / 사이오닉 아이템의 **타게팅을 자동화**해 주는 모듈입니다.

아이템을 챗으로 사용했을 때, 미리 설정해 둔 타겟 타입에 따라  
크로스헤어 또는 장면 하이라이트를 이용해 토큰을 자동으로 타겟팅합니다.

---

### 1. 요구 사항

- Foundry VTT **v13**
- 시스템: **double-cross-3rd**
- 모듈: **sequencer**

---

### 2. 기본 기능

- 콤보 / 이펙트 / 스펠 / 사이오닉 아이템 시트 **헤더에 "타게팅" 버튼** 추가
- 아이템별로 다음 정보를 **Flag로 저장**:
  - 타겟 타입 (`-`, `단일`, `N체`, `범위`, `범위(적)`, `범위(아군)`, `장면`, `장면(적)`, `장면(아군)`)
  - N 값 / 수식 ([level], [이펙트 이름] 포함 수식)
  - 은밀 무시
  - 자신 제외
- 아이템을 챗으로 사용하면, 저장된 설정에 따라:
  - **단일 / N / 범위**: Sequencer 크로스헤어를 띄워 타깃 선택
  - **장면 / 장면(적) / 장면(아군)**: 장면 하이라이트 범위 안의 토큰을 자동 필터링 후 타겟팅

---

### 3. 타겟 타입 설명

- **-**: 타게팅 없음 (아무 동작도 하지 않음)
- **Single (단일)**: 1칸(1x1) 크로스헤어로 한 지점을 찍고, 그 칸과 겹치는 토큰을 모두 타겟팅
- **N (N체)**:
  - 1칸(1x1) 크로스헤어를 **최대 N번**까지 반복해서 찍어, 겹치는 토큰을 차례대로 타겟팅
  - 라벨에 `현재선택수/총N` 형태로 표시 (예: `2/5`)
  - N 값은 `1~99` 또는
    - 이펙트/사이오닉: `[level]` 또는 대응 로컬라이즈된 문자열
    - 콤보: `[이펙트 이름]` (콤보에 포함된 이펙트의 레벨)
    - 위 값들을 이용한 사칙연산 수식 (`[level]+1`, `[이펙트]*2` 등)
- **Area (범위)**:
  - 3x3(9칸) 크로스헤어를 찍어서 해당 범위와 겹치는 **모든 토큰**을 타겟팅
- **Area(Enemies) (범위(적))**:
  - **상대적 적 판단**: 실행하는 액터의 타입에 따라 적이 달라집니다
    - 실행 액터가 `Enemy` 또는 `Troop`이면 → 타겟은 `PlayerCharacter` 또는 `Ally`
    - 실행 액터가 `PlayerCharacter` 또는 `Ally`이면 → 타겟은 `Enemy` 또는 `Troop`
  - **특수 규칙**:  
    아이템의 `system.attackRoll`이 `"-"`가 아니고,  
    액터가 `berserk` 컨디션을 가지며 `system.conditions.berserk.type === "destruction"` 인 경우  
    → **자신만 제외**하고 actorType과 관계없이 범위 내 토큰을 모두 타겟팅
- **Area(Allies) (범위(아군))**:
  - **상대적 아군 판단**: 실행하는 액터의 타입에 따라 아군이 달라집니다
    - 실행 액터가 `Enemy` 또는 `Troop`이면 → 타겟은 `Enemy` 또는 `Troop` (같은 진영)
    - 실행 액터가 `PlayerCharacter` 또는 `Ally`이면 → 타겟은 `PlayerCharacter` 또는 `Ally` (같은 진영)
  - "자신 제외"가 체크되어 있으면 자신의 토큰은 제외
- **Scene (장면)**:
  - 장면에 표시된 **범위 하이라이트 전체**(DX3rdUniversalHandler 큐 기준)를 사용
  - 하이라이트 범위 안의 모든 토큰을, 조건(은밀/숨김/자신 제외 등)에 맞게 자동 타겟팅
- **Scene(Enemies) (장면(적))**:
  - **상대적 적 판단**: **범위(적)**과 동일한 로직 적용
    - 실행 액터가 `Enemy` 또는 `Troop`이면 → 타겟은 `PlayerCharacter` 또는 `Ally`
    - 실행 액터가 `PlayerCharacter` 또는 `Ally`이면 → 타겟은 `Enemy` 또는 `Troop`
  - destruction berserk 특수 규칙은 **범위(적)**과 동일하게 적용
- **Scene(Allies) (장면(아군))**:
  - **상대적 아군 판단**: **범위(아군)**과 동일한 로직 적용
    - 실행 액터가 `Enemy` 또는 `Troop`이면 → 타겟은 `Enemy` 또는 `Troop` (같은 진영)
    - 실행 액터가 `PlayerCharacter` 또는 `Ally`이면 → 타겟은 `PlayerCharacter` 또는 `Ally` (같은 진영)
  - "자신 제외"가 체크되어 있으면 자신의 토큰은 제외

---

### 4. 다이얼로그 옵션

아이템 헤더의 **타게팅** 버튼을 누르면 설정 다이얼로그가 열립니다.

- **타겟 유형**: 위에서 설명한 타입 중 하나 선택
- **N 값**:
  - 타입이 `N`일 때만 입력 가능
  - 단순 숫자 (`1~99`) 또는 수식 / [level] / [이펙트 이름]
- **은밀 무시**:
  - 체크 해제: `stealth` 컨디션/상태를 가진 토큰은 타겟에서 제외
  - 체크: 은밀 여부 무시
- **자신 제외**:
  - `범위`, `범위(아군)`, `장면`, `장면(아군)` 선택 시 활성화
  - 체크 시 자신의 토큰은 타겟팅 대상에서 제외

다이얼로그에서 **확인**을 누르면 설정만 저장되고,  
실제 타게팅은 **아이템을 챗에서 사용했을 때** 자동으로 실행됩니다.

---

### 5. 필터링 처리 규칙

모든 타게팅에서 다음 필터링 규칙이 순서대로 적용됩니다.

#### 5.1 공통 필터링

- **hide된 토큰**: 항상 타겟팅에서 제외 (은밀 무시 설정과 무관)
- **은밀(stealth)**:
  - "은밀 무시" 체크 해제 시: `stealth` 컨디션/상태를 가진 토큰은 제외
  - "은밀 무시" 체크 시: stealth 여부 무시하고 모든 토큰 선택 가능
- **전투 중에만 활성화**:
  - 모듈 설정에서 "전투 중에만 활성화"가 켜져 있으면,  
    현재 컴뱃이 없을 때는 어떤 타게팅도 실행되지 않음

#### 5.2 액터 타입 필터링 (범위(적), 범위(아군), 장면(적), 장면(아군))

**상대적 적/아군 판단**이 적용됩니다. 실행하는 액터의 타입에 따라 적과 아군이 달라집니다.

- **범위(적) / 장면(적)**:
  - 실행 액터가 `Enemy` 또는 `Troop`이면 → 타겟은 `PlayerCharacter` 또는 `Ally`
  - 실행 액터가 `PlayerCharacter` 또는 `Ally`이면 → 타겟은 `Enemy` 또는 `Troop`
  - 실행 액터의 타입이 불명확하면 기본 동작 (타겟은 `Enemy` 또는 `Troop`)

- **범위(아군) / 장면(아군)**:
  - 실행 액터가 `Enemy` 또는 `Troop`이면 → 타겟은 `Enemy` 또는 `Troop` (같은 진영)
  - 실행 액터가 `PlayerCharacter` 또는 `Ally`이면 → 타겟은 `PlayerCharacter` 또는 `Ally` (같은 진영)
  - 실행 액터의 타입이 불명확하면 기본 동작 (타겟은 `PlayerCharacter` 또는 `Ally`)

#### 5.3 특수 규칙

- **destruction berserk 특수 규칙** (범위(적), 장면(적)에만 적용):
  - 조건:
    1. 아이템의 `system.attackRoll`이 `"-"`가 아님
    2. 액터가 `berserk` 컨디션 보유
    3. `system.conditions.berserk.type === "destruction"`
  - 효과: 액터 타입 필터링을 무시하고, **자신만 제외**한 채 범위 내 모든 토큰을 타겟팅

- **자신 제외**:
  - `범위`, `범위(아군)`, `장면`, `장면(아군)`에서만 사용 가능
  - 체크 시 자신의 토큰(`actorParam.id === token.actor.id`)은 타겟팅에서 제외

---

### 6. 모듈 설정

Foundry 설정 → 모듈 설정 → `DX3rd Target Assistant`

- **크로스헤어 이미지**: 기본값 `icons/svg/target.svg` (파일 픽커)
- **크로스헤어 크기**: 배율 (기본 2.0)
- **크로스헤어 투명도**: 0 ~ 1
- **전투 중에만 활성화**:
  - 기본값: **켜짐**
  - 설명: "해제 시 전투가 없더라도 타게팅 크로스헤어를 호출합니다."

---

### 7. 알려진 제약

- DX3rd 시스템의 **범위 하이라이트**(DX3rdUniversalHandler 큐)에 의존하므로,  
  장면/범위 관련 타게팅은 **아이템 사용 시 범위가 먼저 표시된 상태**여야 합니다.
- Sequencer 모듈이 비활성화되면 크로스헤어 기반 타게팅은 동작하지 않습니다.

